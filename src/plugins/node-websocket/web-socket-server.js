const WebSocket = require('isomorphic-ws')
const ContactAddressProtocolType = require('../contact-type/contact-address-protocol-type')

module.exports = class WebSocketServer extends WebSocket.Server {

    constructor(kademliaNode, options = {}) {

        super({
            maxPayload: KAD_OPTIONS.PLUGINS.NODE_WEBSOCKET.MAX_TRANSFER_PAYLOAD_SIZE,
            ...options
        });

        this._kademliaNode = kademliaNode;

        this.on('connection', this.newClientConnection );

    }

    newClientConnection(ws){

        /**
         * Connection Handshake is considered not safe as the certificate can be generated by a hijacked dns. So, Connection Handshake will require forced encryption using public keys.
         * Once the connection handshake is verified, the SSL is considered safe as their is proof from both parties of owning the private keys of the contact public keys.
         */

        this._kademliaNode.rules.receiveSerialized( ws, 0, undefined, ContactAddressProtocolType.CONTACT_ADDRESS_PROTOCOL_TYPE_WEBSOCKET, Buffer.from( ws.protocol, "hex"), {forceEncryption: true, returnNotAllowed: true}, (err, out) =>{

            if (err) return ws.close();

            try{

                ws._kadInitialized = true;

                this._kademliaNode.rules.pluginNodeWebsocketExtends.initializeWebSocket( this._kademliaNode.rules,  out[0], ws, (err, ws)=>{
                    if (err)
                        return ws.close();
                })

            }catch(err){
                return ws.close();
            }

        } );

    }


}